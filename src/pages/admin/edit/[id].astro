---
import Layout from '../../../layouts/Layout.astro'
import { getPostById } from '../../../lib/kv'
import { requireAdmin, AuthError } from '../../../lib/auth'
export const prerender = false
try {
  await requireAdmin(Astro.request)
} catch (e) {
  if (e instanceof AuthError) {
    if (e.status === 401) {
      return Astro.redirect('/sign-in')
    }
    return new Response(e.message, { status: e.status })
  }
  return new Response('Server error', { status: 500 })
}
const post = await getPostById(Astro.params.id!)
if (!post) {
  throw new Response(null, { status: 404 })
}
---
<Layout>
  <main class="p-6 space-y-4">
    <h1 class="text-2xl">Edit Post</h1>
    <form id="post-form" class="space-y-4">
      <input type="text" name="title" value={post.title} class="border p-2 w-full" required />
      <textarea name="description" class="border p-2 w-full" required>{post.description}</textarea>
      <textarea name="content" class="border p-2 w-full h-40" required>{post.content}</textarea>
      <button type="submit" class="bg-green-600 text-white px-4 py-2">Save</button>
    </form>
    <button id="delete-btn" class="text-red-600">Delete</button>
    <script type="module">
      const form = document.getElementById('post-form');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form as HTMLFormElement);
        const body: any = Object.fromEntries(fd.entries());
        const res = await fetch(`/api/posts/${post.id}`, {method:'PATCH', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
        if (res.ok) { window.location.href = '/admin'; } else { alert('Error'); }
      });
      document.getElementById('delete-btn')?.addEventListener('click', async () => {
        if (confirm('Delete post?')) {
          const res = await fetch(`/api/posts/${post.id}`, {method:'DELETE'});
          if (res.ok) window.location.href = '/admin'; else alert('Error');
        }
      });
    </script>
  </main>
</Layout>
