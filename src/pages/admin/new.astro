---
import Layout from '../../layouts/Layout.astro'
import { requireAdmin, AuthError } from '../../lib/auth'
export const prerender = false
try {
  await requireAdmin(Astro.request)
} catch (e) {
  if (e instanceof AuthError) {
    if (e.status === 401) {
      return Astro.redirect('/sign-in')
    }
    return new Response(e.message, { status: e.status })
  }
  return new Response('Server error', { status: 500 })
}
---
<Layout>
  <main class="p-6 space-y-4">
    <h1 class="text-2xl">New Post</h1>
    <form id="post-form" class="space-y-4">
      <input type="text" name="title" placeholder="Title" class="border p-2 w-full" required />
      <textarea name="description" placeholder="Description" class="border p-2 w-full" required></textarea>
      <textarea name="content" placeholder="Content" class="border p-2 w-full h-40" required></textarea>
      <button type="submit" class="bg-green-600 text-white px-4 py-2">Publish</button>
    </form>
    <script type="module">
      const form = document.getElementById('post-form');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form as HTMLFormElement);
        const body: any = Object.fromEntries(fd.entries());
        body.tags = [];
        body.status = 'published';
        const res = await fetch('/api/posts/create', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)});
        if (res.ok) { window.location.href = '/admin'; } else { alert('Error'); }
      });
    </script>
  </main>
</Layout>
